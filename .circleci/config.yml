version: 2.1

# Sử dụng Windows Orb để hỗ trợ các lệnh cơ bản
orbs:
  win: circleci/windows@5.0

jobs:
  deploy_vm:
    # Chọn cấu hình máy ảo Windows (Managed bởi CircleCI)
    executor:
      name: win/default
      size: "medium" # Có sẵn máy ảo, không cần cài runner

    steps:
      - checkout # Tương đương actions/checkout

      - run:
          name: Fast Setup & System Info
          shell: powershell.exe
          command: |
            # Lấy Input từ Environment Variables (Bạn cài trong Project Settings trên Web)
            $OWNER = "$env:OWNER_NAME"
            $KEY = "$env:TS_KEY"

            if (-not $KEY) { Write-Error "Missing Tailscale Key!"; exit 1 }

            # 1. Tạo User
            $p = "CloudAccess@2026!#"
            $password = ConvertTo-SecureString $p -AsPlainText -Force
            if (-not (Get-LocalUser -Name "ZunRdp" -ErrorAction SilentlyContinue)) {
                New-LocalUser -Name "ZunRdp" -Password $password -PasswordNeverExpires
                Add-LocalGroupMember -Group "Administrators" -Member "ZunRdp"
            }
            
            # 2. Cài đặt Tailscale
            curl.exe -L -o ts.exe https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe
            Start-Process -FilePath "ts.exe" -ArgumentList "/quiet", "/norestart" -Wait
            
            # Đợi và Connect
            Start-Sleep -Seconds 5
            & "C:\Program Files\Tailscale\tailscale.exe" up --authkey="$KEY" --hostname="ZUN-CIRCLE-$CIRCLE_BUILD_NUM"
            
            # 3. Chạy Agent của bạn
            if (Test-Path "zunrdp.ps1") {
                powershell.exe -ExecutionPolicy Bypass -File zunrdp.ps1 -Owner "$OWNER" -MachineID "ZUN-$CIRCLE_BUILD_NUM"
            }

workflows:
  zun_workflow:
    jobs:
      - deploy_vm
